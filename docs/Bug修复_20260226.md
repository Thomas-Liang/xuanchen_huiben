# Bug修复记录 - 20260226

## 问题描述

用户反馈：web端点击按钮报错

错误信息：

```
Uncaught (in promise) {code: -1, message: undefined}
Promise.then
e.init @ content.js:1
```

## 问题分析

1. 用户直接在浏览器中访问 `dist/index.html` 或通过 `http://localhost:1420/` 访问
2. Tauri 应用的前端代码使用 `@tauri-apps/api/core` 的 `invoke` 方法调用 Rust 后端
3. `invoke` 方法只能在 Tauri 窗口环境中使用，在普通浏览器中无法工作

## 解决方案

实现前端同时支持 Tauri 和 浏览器两种运行环境：

### 1. 添加 HTTP API 支持

在 Rust 后端添加 axum HTTP 服务器：

- 新增依赖：`axum`, `tokio`, `tower-http` (cors)
- 创建 `src-tauri/src/api.rs`，实现 REST API
- API 端点：
  - `POST /api/parse` - 解析提示词
  - `GET /api/bindings` - 获取所有绑定
  - `POST /api/bindings/for-prompt` - 获取指定角色的绑定
  - `POST /api/save-image` - 保存参考图
  - `POST /api/bind` - 绑定角色
  - `POST /api/unbind` - 解绑角色

### 2. 修改后端入口

修改 `src-tauri/src/lib.rs`：

- 使用 `#[tokio::main]` 异步运行时
- 启动 axum HTTP 服务器（端口 3001）
- 保留 Tauri invoke handler

### 3. 创建前端适配层

创建 `src/api.ts`：

- 检测运行环境：`isTauri()` 函数检查 `window.__TAURI__`
- 根据环境选择调用方式：
  - Tauri 窗口：使用 `invoke`
  - 浏览器：使用 `fetch` 调用 HTTP API
- 统一导出 API 函数

### 4. 修改前端代码

修改 `src/App.tsx`：

- 移除 `invoke` 直接调用
- 改用 `./api` 模块的函数

### 5. 添加 CORS 支持

在 axum router 中添加 CorsLayer，允许跨域请求。

## 修改的文件

1. `src-tauri/Cargo.toml` - 新增依赖
2. `src-tauri/src/api.rs` - 新建文件
3. `src-tauri/src/lib.rs` - 修改入口
4. `src-tauri/src/main.rs` - 修改入口调用
5. `src-tauri/src/commands/character_binding.rs` - 公开静态变量
6. `src/api.ts` - 新建文件
7. `src/App.tsx` - 修改 API 调用
8. `vite.config.ts` - 修改端口配置

## 运行方式

### 浏览器模式（新增）

```bash
npm run tauri dev
# 访问 http://localhost:1420
# API: http://localhost:3001
```

### Tauri 桌面模式

```bash
npm run tauri dev
# 在 Tauri 窗口中运行
```

## 测试验证

1. 浏览器访问 http://localhost:1420
2. 输入提示词如 "在森林里@小明 跑步"
3. 点击"开始解析"按钮
4. 解析成功，显示角色和分段结果
5. 可以绑定参考图

## 修复日期

2026-02-26
