# 开发记录 - 2026-02-27 15:33

## 问题与修复总结：绑定参考图与图像生成卡死及显示问题

### 1. 修复上传卡死与限制问题（后端体积限制解除 & Tauri IPC 迁移）
- **问题：** 当用户在页面中进行“确认绑定”并上传参考图时，如果图片由于使用 Web 请求接口上传而发生超时或者 Payload 过大，会在“开始解析/确认绑定”阶段卡住而失去响应。且网页端原本受到局域网内置框架 (`axum`) 的请求体默认 2MB 限制（`Payload Too Large`）。
- **优化点（Desktop）：** 在前端通信层 `src/api.ts` 添加了对于桌面端的跨进程直接打通支持。如果运行在桌面端环境下，`saveReferenceImage`、`bindCharacterReference` 等方法不再走 HTTP 代理，而是直接通过高并发安全的 Tauri 原生 `invoke` 发送到底层 Rust 进行处理，彻底清除了大图片的网络卡顿。
- **修复点（Web）：** 在后端的 HTTP 服务框架中 (`src-tauri/src/api.rs`)，为 `Router` 增加了 `axum::extract::DefaultBodyLimit::max(50 * 1024 * 1024)` 配置，将全局 Web 传输上限提高至 50MB。网页端上传也不会再被后端静默拒绝了。

### 2. 修复图片/头像缩略图显示异常问题
- **问题：** 第一步解决完存图后，圆圈内部的预览缩略图未能正确显示。这是受限于现代浏览器的严格本地文件系统安全策略（`Not allowed to load local resource`），由于原本保存的是用户的 `C:\...` 绝对路径，前端 `<img>` 标签直接读取必然遭到拦截。另外返回数据的下划线形式也被前端意外忽略。
- **修复措施：** 
  - **后端数据传输枢纽**：在 `api.rs` 内新增了专门负责在全平台读图的路由通道 `[GET] /api/image?path=xxx`，能够自动识别 `jpeg / png / webp` 扩展名且以二进制流回传正确的图片内容。
  - **前端自动包裹**：补充了前端工具函数 `getImageUrl(path)` 在 `src/api.ts` 以清洗出标准网址请求，并在 `App.tsx` 中的所有“已绑定的图片”头像读取处接入这一流程，使 Web 或 Tauri 下均能正常预览。
  - **字段适配（蛇形自动转驼峰）**：在前端 API 通道做了一小步统一包装 `normalizeCharacterBinding`，抹平了从 Rust 抛出 `reference_image_path` 后由于 TypeScript 层面的接口寻找的是 `referenceImagePath` 而引发的数据丢失。

### 3. 修复开始生图后导致 400/415/524 及“空内容”拒绝的问题
- **问题：** 点击生成后大模型接口报错参数无效甚至出现空 JSON 被切断连接 (`Unsupported Media Type` 与 `524 timeout`)。第一是因为没有给模型传真正可读的 Base64 编码，只提交了一串它访问不到的电脑文件路径；第二是因为传了真正的图片后，好几张千万级像素、大小动辄十几 MB 的参考图累积变成了高达上百 MB 的文本包被模型直接判定为恶意洪水攻击而截断拦截。
- **修复措施：**
  - **图片格式与拼装规范**：在组装大模型发起的载荷 `images` （针对 `Seedream` 等模型）时，按照标准增加了头信息 (`data:image/png;base64,xxxx`)，让 API 服务器不再报格式无效。
  - **智能无损极速压缩策略（重要！）**：在 `src-tauri/Cargo.toml` 新引入了 Rust 的王牌 `image` 图形库。于是在提交任何请求前，我们在打包阶段判断单图是否有过大：凡是超过 `1MB` 文件体积，或者画面分辨率超过 `1024x1024` 的重磅参考图，服务端会自动调用并维持纵横比使用超清插值算法 (`Lanczos3`) 帮图片“智能瘦身”，并转换封装为 `Jpeg (Quality: 80)`。随后再进行 Base64 加密压缩。这导致原本几张加起来几万 KB 动辄超标引起各种超范围错误的数据暴跌回几百 KB 以内，彻底化解网络崩坏问题。

---

**核心涉及文件：**
- `src/App.tsx` (缩略图展示映射)
- `src/api.ts` (前端接口及参数处理修正、加入 `invoke` IPC)
- `src-tauri/src/api.rs` (大图片无限制路由、`/api/image` 视图接口)
- `src-tauri/src/commands/image_generator.rs` (接入 `image` 压缩、Base64 `data:` 头补充)
- `src-tauri/Cargo.toml` (新增 `image = "0.24"`)
