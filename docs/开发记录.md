# 泫晨懿然·灵犀绘梦 - 开发记录

## Sprint 0: 项目初始化

### 2026-02-25

#### 完成的工作

1. **Tauri + React 项目初始化**
   - 使用 `npm create tauri-app` 创建项目
   - 技术栈: React 18 + TypeScript + Vite + Tauri 2.x
   - 项目名称: xuanchen-huiben

2. **开发环境配置**
   - 安装 ESLint、Prettier
   - 安装 Zustand (状态管理)
   - 安装 Axios (HTTP请求)
   - 安装 Ant Design (UI组件)
   - 配置 `.eslintrc.json` 和 `.prettierrc`

3. **项目结构搭建**

   ```
   src/
   ├── components/     # React组件
   ├── hooks/          # 自定义Hooks
   ├── types/          # TypeScript类型定义
   ├── services/       # API服务
   ├── store/          # Zustand状态管理
   └── utils/          # 工具函数

   src-tauri/
   └── src/
       └── commands/   # Tauri命令
   ```

4. **核心类型定义** (`src/types/index.ts`)
   - `PromptSegment` - 提示词分段
   - `ParsedPrompt` - 解析结果
   - `CharacterRef` - 角色引用
   - `CharacterBinding` - 角色绑定
   - `ImageGenerationParams` - 出图参数
   - `APIConfig` - API配置

5. **状态管理** (`src/store/index.ts`)
   - 使用 Zustand + persist 中间件
   - 管理 API配置、解析结果、角色绑定、出图参数

6. **Rust后端命令** (`src-tauri/src/lib.rs`)
   - `parse_prompt` - 提示词解析（提取@角色、分段）
   - 支持中文字符识别

7. **前端界面** (`src/App.tsx`)
   - 提示词输入框
   - 解析结果显示（角色列表、分段结果）
   - Ant Design UI组件

8. **配置文件更新**
   - `tauri.conf.json` - 应用名称、大小、窗口配置
   - `package.json` - 项目名称、脚本配置
   - `Cargo.toml` - Rust依赖

#### 遇到的问题

1. **Rust编译链接问题**
   - MSVC链接器环境配置复杂
   - 当前环境: VS Build Tools 14.44 + Windows SDK 10.0.26100
   - 错误: `LINK : fatal error LNK1104: 无法打开文件"msvcrt.lib"`
   - 解决方案: 配置正确的环境变量后成功编译

---

### 2026-02-26

#### 完成的工作

1. **完善提示词分割引擎** (`src-tauri/src/commands/prompt_parser.rs`)
   - 扩展关键词库，支持中英文
   - 场景关键词: forest, beach, mountain, city, 在, 位于, 森林, 海边等
   - 动作关键词: running, walking, jumping, 奔跑, 跳跃, 行走等
   - 角色关键词: character, person, 人, 角色, 英雄等
   - 背景关键词: background, 背景, 环境等
   - 实现基于标点符号的多段分割逻辑

2. **新增Segment分类支持**
   - scene (场景)
   - action (动作)
   - character (角色)
   - background (背景)
   - other (其他)

3. **segment_text函数实现**
   - 按标点符号（，。！？；等）分割文本
   - 对每个分段进行类型识别
   - 返回带位置信息的分段列表

4. **US-001功能优化**
   - 扩展分割类型：新增 time(时间)、weather(天气)、style(风格)
   - 优化关键词匹配算法
   - 更新前端类型定义和UI

5. **测试验证**
   - 添加4个Rust单元测试用例
   - 全部测试通过
   - 创建测试案例文档

#### 文档更新

- 更新 `US-001_开发记录_20260226.md`
- 新建 `US-001_测试案例_20260226.md`

---

## Sprint 1: 核心功能开发

### 2026-02-26

#### 完成的工作

1. **US-001 提示词分割功能** ✅
   - 完善提示词分割引擎，扩展关键词库支持中英文
   - 新增Segment分类: scene, action, character, background, time, weather, style
   - 4个Rust单元测试全部通过
   - 创建测试案例文档

2. **US-002 角色绑定功能** ✅
   - 创建角色绑定后端命令 (`character_binding.rs`)
   - 实现保存/绑定/解绑/查询角色参考图功能
   - 支持拖拽上传图片
   - 支持从已有图库选择参考图
   - 10个测试用例全部通过

#### 文档更新

- 更新 `US-001_开发记录_20260226.md`
- 新建 `US-001_测试案例_20260226.md`
- 更新 `US-002_开发记录_20260226.md`
- 新建 `US-002_测试案例_20260226.md`

---

### 2026-02-26 (下午)

#### 完成的工作

1. **US-004 出图参数配置** ✅
   - 新增 `GenerationConfig` 类型定义 (`src/types/index.ts`)
   - 后端新增保存/加载生成参数配置命令 (`src-tauri/src/commands/image_generator.rs`)
     - `save_generation_config` - 保存生成参数配置
     - `load_generation_config` - 加载生成参数配置
     - `get_default_generation_config` - 获取默认配置
   - 前端新增API函数 (`src/api.ts`)
   - 前端UI添加"保存为默认配置"按钮
   - 应用启动时自动加载已保存的生成参数配置

2. **API配置优化**
   - 支持测试连接时使用当前输入的API Key和Base URL
   - API配置支持可选字段，前端后端命名格式兼容 (baseUrl/base_url, apiKey/api_key)

3. **Seeddream 4.5 模型支持**
   - 新增 `seedream` 模型选项（替换原有的jimeng）
   - 前端根据选择模型显示不同参数：
     - Seeddream: 图片尺寸(1K/2K/4K)、组图功能、返回格式、水印
     - Banana Pro: 图片尺寸、生成数量、图片质量
   - 后端新增 `call_seedream_api` 函数
   - 默认API地址: https://api.zhongzhuan.chat

4. **角色参考图绑定功能优化**
   - Seeddream模型支持通过images参数传入角色参考图
   - 角色绑定API支持驼峰命名和下划线命名兼容
   - 前端暂时跳过API调用，使用本地状态管理

5. **API请求格式优化**
   - 后端API使用serde_json::Value接收请求，灵活处理各种字段命名
   - 前端统一使用snake_case格式发送请求
   - 修复了character_bindings字段解析问题

#### 文档更新

- 更新 `开发记录.md`
- 更新 `US-004_测试案例_20260226.md`

---

## 待完成 (Sprint 2)

- [x] US-001 提示词分割功能完善
- [x] US-002 角色绑定功能
- [ ] US-003 AI出图功能
- [x] US-004 参数配置
- [ ] US-005 桌面应用基础功能
- [ ] US-007 三方API配置

---

## 技术架构

```
┌─────────────────────────────────────────┐
│         Tauri Desktop App                │
│  ┌─────────────────┐  ┌──────────────┐  │
│  │ React Frontend  │◀▶│ Tauri Cmds  │  │
│  │ (TypeScript)    │  │   (Rust)     │  │
│  └─────────────────┘  └──────────────┘  │
└─────────────────────────────────────────┘
                   │
       ┌───────────▼───────────┐
       │   AI Model API        │
       │ (即梦 / Banana Pro)   │
       └───────────────────────┘
```

## 依赖版本

- React: 19.1.0
- TypeScript: 5.8.3
- Vite: 7.0.4
- Tauri: 2.x
- Zustand: 5.x
- Ant Design: 6.x
- Axios: 1.x

---

## Bug修复记录

### 2026-02-26

#### 问题：web端点击按钮报错

**问题描述**：

- 用户直接在浏览器中访问时，`invoke` 方法无法使用
- 错误：`Uncaught (in promise) {code: -1, message: undefined}`

**解决方案**：

- 添加 HTTP API 支持（axum）
- 前端自动检测运行环境，选择 `invoke` 或 `fetch`
- 端口：3001

**修改文件**：

- 新增 `src-tauri/src/api.rs`
- 新增 `src/api.tssrc-tauri/src`
- 修改 `/lib.rs`, `src-tauri/src/main.rs`
- 修改 `src/App.tsx`

**文档**：`Bug修复_20260226.md`
