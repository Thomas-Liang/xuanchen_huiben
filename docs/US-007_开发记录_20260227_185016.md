# US-007 三方API配置 - 开发记录

**文档版本**: 1.0  
**创建日期**: 2026-02-27  
**时间戳**: 20260227_185016  
**User Story**: US-007  
**最后更新**: 2026-02-27

---

## 1. 需求概述

### 1.1 标题

作为用户，我希望能够配置即梦和Banana Pro的API地址和密钥

### 1.2 优先级与故事点

- 优先级: P0 (High)
- 故事点: 3

### 1.3 验收标准

- [x] 支持配置即梦API的Base URL
- [x] 支持配置即梦API Key
- [x] 支持配置Banana Pro API的Base URL
- [x] 支持配置Banana Pro API Key
- [x] 支持测试API连接是否可用
- [x] API配置支持本地保存
- [x] API配置支持加密存储

---

## 2. 技术实现

### 2.1 后端实现 (Rust/Tauri)

#### 新增依赖

在 `Cargo.toml` 中添加以下依赖：

```toml
aes-gcm = "0.10"
rand = "0.8"
sha2 = "0.10"
pbkdf2 = "0.12"
```

#### 核心函数

| 函数名                   | 功能                    | 文件位置           |
| ------------------------ | ----------------------- | ------------------ |
| `save_api_config`        | 保存API配置（加密存储） | image_generator.rs |
| `load_api_config`        | 加载API配置（解密）     | image_generator.rs |
| `get_default_api_config` | 获取默认API配置         | image_generator.rs |
| `test_api_connection`    | 测试API连接             | image_generator.rs |

#### 加密实现

使用AES-256-GCM对称加密算法实现API配置的加密存储：

```rust
// 加密流程
1. 使用随机数生成32字节密钥
2. 密钥存储在 key.bin 文件中
3. 保存配置时：
   - 生成12字节随机nonce
   - 使用AES-256-GCM加密JSON数据
   - 存储格式: nonce(12字节) + ciphertext
4. 加载配置时：
   - 读取key.bin获取密钥
   - 解析加密数据提取nonce和密文
   - 解密得到明文JSON
```

#### 数据结构

```rust
pub struct ApiConfig {
    pub seedream: ModelConfig,
    pub banana_pro: ModelConfig,
}

pub struct ModelConfig {
    pub base_url: String,
    pub api_key: String,
}
```

#### 配置文件路径

- API配置: `{app_data}/xuanchen-huiben/api_config.json` (加密)
- 加密密钥: `{app_data}/xuanchen-huiben/key.bin`
- 生成配置: `{app_data}/xuanchen-huiben/generation_config.json`

### 2.2 前端实现 (React/TypeScript)

#### API接口

在 `src/api.ts` 中新增/更新以下函数：

| 函数名                | 功能            |
| --------------------- | --------------- |
| `saveApiConfig`       | 保存API配置     |
| `getDefaultApiConfig` | 获取默认API配置 |
| `testApiConnection`   | 测试API连接     |

#### UI组件

在 `src/App.tsx` 中实现API配置Modal：

- Seedream API配置区域（Base URL + API Key + 测试连接按钮）
- Banana Pro API配置区域（Base URL + API Key + 测试连接按钮）
- 保存按钮

---

## 3. 完成的功能

### 3.1 Seedream部分（已完成）

- [x] Base URL配置（默认: https://eggfans.com）
- [x] API Key配置
- [x] 本地保存
- [x] 加密存储
- [x] 测试连接功能
- [x] API调用（图像生成）

### 3.2 Banana Pro部分（已完成）

- [x] Base URL配置（默认: https://api.zhongzhuan.chat）
- [x] API Key配置
- [x] 本地保存
- [x] 加密存储
- [x] 测试连接功能
- [x] API调用（图像生成）

---

## 4. 遗留问题

无

---

## 5. 相关文件

### 修改的文件

- `src-tauri/Cargo.toml` - 添加加密依赖
- `src-tauri/src/commands/image_generator.rs` - 实现加密存储逻辑
- `src/api.ts` - 前端API接口
- `src/App.tsx` - API配置UI

### 文档

- `docs/US-007_开发记录_20260227_185016.md` - 本文档
- `docs/US-007_测试案例_20260227_185016.md` - 测试案例

---

_文档结束_
