# US-003 开发记录 - AI出图功能

**文档创建时间**: 2026-02-26

---

## 需求概述

**US-003: AI出图功能**

- **标题**: 作为用户，我希望能够选择即梦或banana pro模型进行AI出图
- **优先级**: P0 (High)
- **故事点**: 8

### 验收标准

- [x] 支持选择即梦模型进行出图
- [x] 支持选择banana pro模型进行出图
- [x] 能够将分割后的提示词、绑定的角色参考图发送给AI模型
- [x] 返回生成的图片结果
- [x] 显示生成进度

---

## 开发记录

### 2026-02-26

#### 完成的工作

1. **创建AI出图后端命令模块** (`src-tauri/src/commands/image_generator.rs`)
   - 实现 `generate_image` - AI图片生成主命令
   - 实现 `save_api_config` - 保存API配置
   - 实现 `load_api_config` - 加载API配置
   - 实现 `get_default_api_config` - 获取默认API配置
   - 实现 `get_generation_progress` - 获取生成进度
   - 实现 `test_api_connection` - 测试API连接
   - 实现 `load_config_from_file` - 启动时加载配置

2. **添加依赖**
   - 在 `Cargo.toml` 中添加 `chrono = "0.4"` 用于生成时间戳任务ID
   - 添加 `dirs = "5"` 用于获取系统目录
   - 添加 `reqwest = { version = "0.12", features = ["json"] }` 用于HTTP请求

3. **更新模块导出** (`src-tauri/src/commands/mod.rs`)
   - 添加 `pub mod image_generator;`

4. **注册Tauri命令** (`src-tauri/src/lib.rs`)
   - 导入并注册所有AI出图相关命令
   - 添加启动时加载API配置

5. **添加API路由** (`src-tauri/src/api.rs`)
   - 添加 `/api/generate` 端点用于图片生成
   - 添加 `/api/config/save` 端点用于保存配置
   - 添加 `/api/config/default` 端点用于获取默认配置

6. **更新前端类型定义** (`src/types/index.ts`)
   - 添加 `CharacterBindingInfo` 类型用于API调用
   - 修改 `ImageGenerationParams` 使用正确类型

7. **更新前端API** (`src/api.ts`)
   - 添加 `generateImage` 函数
   - 添加 `getGenerationProgress` 函数
   - 添加 `saveApiConfig` 函数
   - 添加 `getDefaultApiConfig` 函数

8. **更新前端UI** (`src/App.tsx`)
   - 添加模型选择下拉框 (即梦/Banana Pro)
   - 添加图片尺寸选择 (512x512, 768x768, 1024x1024等)
   - 添加生成数量选择 (1张, 2张, 4张)
   - 添加生成按钮和进度显示
   - 添加生成结果展示和下载
   - 添加API配置Modal

---

## 技术实现

### 后端Rust实现

```rust
// AI图片生成命令
#[tauri::command]
pub async fn generate_image(
    params: ImageGenerationParams,
) -> Result<ImageGenerationResult, String> {
    // 1. 创建任务ID
    // 2. 调用对应的AI模型API (即梦/Banana Pro)
    // 3. 返回生成的图片URL
}

// API配置管理
#[tauri::command]
pub fn save_api_config(config: ApiConfig) -> Result<bool, String> {
    // 保存配置到AppData目录
}
```

### 前端实现

```tsx
// 模型选择
<Select
  value={selectedModel}
  onChange={setSelectedModel}
  options={[
    { value: 'jimeng', label: '即梦 (Jimeng)' },
    { value: 'banana_pro', label: 'Banana Pro' },
  ]}
/>

// 生成按钮
<Button
  type="primary"
  icon={<RobotOutlined />}
  onClick={handleGenerate}
  loading={generating}
>
  {generating ? '生成中...' : '开始生成'}
</Button>

// 进度显示
<Progress
  percent={generationProgress}
  status="active"
/>

// 结果展示
<Row gutter={16}>
  {generationResult.images.map((img, idx) => (
    <Col key={idx}>
      <Image src={img} />
    </Col>
  ))}
</Row>
```

---

## 待完善

- [x] 支持选择即梦模型
- [x] 支持选择Banana Pro模型
- [x] 发送提示词和绑定信息给AI
- [x] 显示生成结果
- [x] 显示生成进度
- [x] 完善API配置测试功能
- [x] 支持更多参数配置 (如质量、风格等)

---

## 2026-02-26 (待完善功能更新)

### 完成的工作

1. **完善API配置测试功能**
   - 更新 `test_api_connection` 命令，实际测试API连接
   - 添加 `testApiConnection` 前端API函数
   - 在API配置Modal中添加"测试连接"按钮
   - 支持分别测试即梦和Banana Pro的API连接

2. **支持图片质量参数配置**
   - 前端添加图片质量下拉选择 (标准/高清/超清)
   - 传递质量参数到AI生成请求
   - 优化UI布局，将质量选择与尺寸、数量并排显示

---

### 新增代码

```tsx
// 图片质量选择
<Select
  value={imageQuality}
  onChange={setImageQuality}
  options={[
    { value: 'standard', label: '标准' },
    { value: 'high', label: '高清' },
    { value: 'ultra', label: '超清' },
  ]}
/>

// 测试连接按钮
<Button
  type="link"
  onClick={() => handleTestApi('jimeng')}
  loading={testingApi === 'jimeng'}
>
  测试连接
</Button>
```

---

## 依赖

- Rust: tauri 2.x, reqwest, chrono, dirs
- 前端: React 18 + TypeScript + Ant Design
- HTTP请求: reqwest (Rust) / fetch (Frontend)

---

## 编译状态

| 项目       | 状态    |
| ---------- | ------- |
| TypeScript | ✅ 通过 |
| Rust       | ✅ 通过 |

---

## 验收标准完成情况

| 验收标准                                           | 状态    |
| -------------------------------------------------- | ------- |
| 支持选择即梦模型进行出图                           | ✅ 完成 |
| 支持选择banana pro模型进行出图                     | ✅ 完成 |
| 能够将分割后的提示词、绑定的角色参考图发送给AI模型 | ✅ 完成 |
| 返回生成的图片结果                                 | ✅ 完成 |
| 显示生成进度                                       | ✅ 完成 |
