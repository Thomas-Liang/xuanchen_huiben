# US-005 开发记录

**用户故事**: 桌面应用基础功能  
**标题**: 作为用户，我希望应用具备桌面软件的基础体验  
**开发日期**: 2026-02-27  
**状态**: ✅ 已完成

---

## 需求概述

用户需要桌面应用的基础功能体验，包括：

- 窗口支持最小化、最大化、关闭
- 应用支持系统托盘运行
- 支持全局快捷键快速唤起
- 生成的图片支持本地保存

---

## 完成的工作

### 1. 依赖更新 (src-tauri/Cargo.toml)

新增Tauri插件依赖：

```toml
tauri = { version = "2", features = ["tray-icon", "image-png"] }
tauri-plugin-global-shortcut = "2"
tauri-plugin-dialog = "2"
tauri-plugin-fs = "2"
```

### 2. 配置文件更新 (src-tauri/tauri.conf.json)

- 添加窗口装饰配置 `decorations: true`
- 添加系统托盘配置 `trayIcon`
- 添加全局快捷键和对话框插件配置

### 3. 系统托盘实现 (src-tauri/src/lib.rs)

- 创建系统托盘图标
- 实现托盘菜单：显示窗口、最小化到托盘、退出
- 左键单击托盘图标显示窗口
- 关闭按钮最小化到托盘而非退出应用

```rust
let _tray = TrayIconBuilder::new()
    .icon(Image::from_path("icons/icon.png").unwrap_or_else(|_| {
        Image::from_bytes(include_bytes!("../icons/32x32.png")).unwrap()
    }))
    .menu(&menu)
    .tooltip("泫晨懿然·灵犀绘梦助手")
    .on_menu_event(|app, event| {
        match event.id.as_ref() {
            "show" => { /* 显示窗口 */ }
            "hide" => { /* 最小化到托盘 */ }
            "quit" => { /* 退出应用 */ }
            _ => {}
        }
    })
    .on_tray_icon_event(|tray, event| {
        if let TrayIconEvent::Click { button: MouseButton::Left, .. } = event {
            let app = tray.app_handle();
            if let Some(window) = app.get_webview_window("main") {
                let _ = window.show();
                let _ = window.set_focus();
            }
        }
    })
    .build(app)?;
```

### 4. 全局快捷键实现 (src-tauri/src/lib.rs)

- 注册全局快捷键 `Ctrl+Shift+P`
- 快捷键功能：切换窗口显示/隐藏状态

```rust
let shortcut = Shortcut::new(Some(Modifiers::CONTROL | Modifiers::SHIFT), Code::KeyP);
let app_handle = app.handle().clone();
app.global_shortcut().on_shortcut(shortcut, move |_app, _shortcut, _event| {
    if let Some(window) = app_handle.get_webview_window("main") {
        if window.is_visible().unwrap_or(false) {
            let _ = window.hide();
        } else {
            let _ = window.show();
            let _ = window.set_focus();
        }
    }
})?;
app.global_shortcut().register(shortcut)?;
```

### 5. 图片保存功能 (src-tauri/src/lib.rs)

新增命令 `save_image_to_file`，支持保存Base64和URL图片到本地文件：

```rust
#[tauri::command]
async fn save_image_to_file(image_url: String, file_path: String) -> Result<String, String> {
    if image_url.starts_with("data:image") {
        // Base64图片解码保存
    } else if image_url.starts_with("http://") || image_url.starts_with("https://") {
        // URL图片下载保存
    } else {
        Err("Unsupported image format".to_string())
    }
}
```

### 6. 前端API更新 (src/api.ts)

新增函数：

- `saveImageToFile` - 调用后端命令保存图片
- `saveImageDialog` - 打开保存对话框并保存图片

### 7. 前端UI更新 (src/App.tsx)

- 生成结果增加"保存到本地"按钮
- 使用系统对话框选择保存路径

### 8. 前端依赖更新 (package.json)

新增依赖：

```json
"@tauri-apps/plugin-dialog": "^2"
```

---

## 修改的文件

| 文件                        | 修改内容                               |
| --------------------------- | -------------------------------------- |
| `src-tauri/Cargo.toml`      | 新增系统托盘、快捷键、对话框插件依赖   |
| `src-tauri/tauri.conf.json` | 添加窗口配置和系统托盘配置             |
| `src-tauri/src/lib.rs`      | 实现系统托盘、全局快捷键、图片保存命令 |
| `src/api.ts`                | 新增图片保存API函数                    |
| `src/App.tsx`               | 添加保存图片UI功能                     |
| `package.json`              | 新增dialog插件依赖                     |

---

## 验收标准

- [x] 窗口支持最小化、最大化、关闭
- [x] 应用支持系统托盘运行
- [x] 支持全局快捷键快速唤起 (Ctrl+Shift+P)
- [x] 生成的图片支持本地保存

---

## 后续优化

- 添加托盘气泡通知
- 支持自定义全局快捷键
- 添加开机自启动功能
