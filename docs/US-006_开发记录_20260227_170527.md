# US-006 参考图管理 - 开发记录

**文档版本**: 1.1  
**创建日期**: 2026-02-27  
**时间戳**: 20260227_170527  
**User Story**: US-006  
**最后更新**: 2026-02-27

---

## 1. 需求概述

### 1.1 标题

作为用户，我希望能够管理我的角色和场景参考图

### 1.2 优先级与故事点

- 优先级: P2 (Low)
- 故事点: 3

### 1.3 验收标准

- [x] 支持查看已上传的参考图列表 (人物/场景)
- [x] 支持删除不需要的参考图
- [x] 参考图支持分类/标签管理
- [x] 支持搜索参考图

---

## 2. 技术实现

### 2.1 后端实现 (Rust/Tauri)

#### 新增命令

| 命令名                      | 功能                       | 参数                               |
| --------------------------- | -------------------------- | ---------------------------------- |
| `get_reference_images`      | 获取参考图列表（支持筛选） | query: Option<ReferenceImageQuery> |
| `search_reference_images`   | 搜索参考图                 | keyword: String                    |
| `add_tag_to_reference`      | 添加标签                   | characterName: String, tag: String |
| `remove_tag_from_reference` | 移除标签                   | characterName: String, tag: String |
| `get_all_tags`              | 获取所有标签               | 无                                 |
| `get_references_by_type`    | 按类型获取参考图           | imageType: String                  |

#### 数据结构扩展

```rust
// CharacterBinding 新增字段
pub struct CharacterBinding {
    pub character_name: String,
    pub reference_image_path: Option<String>,
    pub image_type: String,
    pub created_at: String,
    pub bound: bool,
    pub tags: Vec<String>,  // 新增
}

// 查询结构
pub struct ReferenceImageQuery {
    pub image_type: Option<String>,
    pub search: Option<String>,
    pub tags: Option<Vec<String>>,
}

// 标签存储
pub static REFERENCE_TAGS: Lazy<std::sync::Mutex<HashMap<String, Vec<String>>>> = ...
```

#### 文件存储

- 参考图: `%APPDATA%/xuanchen-huiben/reference_images/`
- 绑定数据: `%APPDATA%/xuanchen-huiben/config/character_bindings.json`
- 标签数据: `%APPDATA%/xuanchen-huiben/config/reference_tags.json`

### 2.2 前端实现 (React/TypeScript)

#### API 新增

| 函数名                   | 功能           |
| ------------------------ | -------------- |
| `getReferenceImages`     | 获取参考图列表 |
| `searchReferenceImages`  | 搜索参考图     |
| `addTagToReference`      | 添加标签       |
| `removeTagFromReference` | 移除标签       |
| `getAllTags`             | 获取所有标签   |
| `getReferencesByType`    | 按类型获取     |
| `deleteReferenceImage`   | 删除参考图     |

#### UI 组件

1. **导航栏按钮**: "参考图管理" 按钮
2. **参考图管理模态框**:
   - 搜索框（按角色名/标签搜索）
   - 类型筛选下拉框（人物/场景）
   - 标签多选筛选
   - 参考图网格展示（卡片形式）
   - 删除按钮（带确认）
   - 标签添加/移除功能

---

## 3. 修改文件清单

### 3.1 后端文件

| 文件路径                                      | 修改类型 |
| --------------------------------------------- | -------- |
| `src-tauri/src/commands/character_binding.rs` | 扩展     |
| `src-tauri/src/lib.rs`                        | 扩展     |

### 3.2 前端文件

| 文件路径             | 修改类型 |
| -------------------- | -------- |
| `src/api.ts`         | 扩展     |
| `src/types/index.ts` | 扩展     |
| `src/App.tsx`        | 扩展     |

---

## 4. 测试验证

### 4.1 功能测试

- [ ] 查看参考图列表
- [ ] 按类型筛选（人物/场景）
- [ ] 搜索参考图
- [ ] 删除参考图
- [ ] 添加标签
- [ ] 移除标签
- [ ] 按标签筛选

### 4.2 验收标准对照

| 验收标准                   | 状态      |
| -------------------------- | --------- |
| 支持查看已上传的参考图列表 | ✅ 已实现 |
| 支持删除不需要的参考图     | ✅ 已实现 |
| 参考图支持分类/标签管理    | ✅ 已实现 |
| 支持搜索参考图             | ✅ 已实现 |

---

## 6. 参考图流程说明

### 6.1 绑定参考图流程

```
输入提示词（含@角色名）
    ↓
点击「开始解析」
    ↓
系统识别出角色 → 显示绑定按钮
    ↓
点击「绑定参考图」
    ↓
选择或上传图片 → 选择类型（人物/场景）
    ↓
点击「确认绑定」
    ↓
参考图自动保存到图库
```

### 6.2 从图库选择流程

```
在绑定参考图弹窗中
    ↓
点击「从图库选择」
    ↓
在图库弹窗中浏览/搜索参考图
    ↓
点击选择目标参考图
    ↓
自动填入当前绑定表单
```

### 6.3 参考图管理功能

- **查看列表**: 点击导航栏「参考图管理」按钮
- **筛选**: 按类型（人物/场景）、按标签筛选
- **搜索**: 按角色名或标签搜索
- **标签管理**: 为参考图添加/移除标签
- **删除**: 删除不需要的参考图

---

## 7. 总结

US-006 参考图管理功能已完成开发，实现了需求文档中定义的所有验收标准。该功能允许用户：

1. 查看所有已上传的参考图
2. 按类型（人物/场景）筛选
3. 按角色名或标签搜索
4. 删除不需要的参考图
5. 为参考图添加和移除标签
6. 按标签进行多选筛选

所有数据均存储在本地，支持持久化。
