# US-002 开发记录 - 角色绑定功能

**文档创建时间**: 2026-02-26

---

## 需求概述

**US-002: 角色绑定功能**

- **标题**: 作为用户，我希望使用@符号能将提示词中的角色与参考图进行绑定
- **优先级**: P0 (High)
- **故事点**: 8

### 验收标准

- [x] 用户可以使用@角色名来引用需要绑定的角色
- [x] 用户可以上传或选择角色的参考图片 (人物/场景均可，可选)
- [x] 系统能够将@角色与对应的参考图建立关联
- [x] 支持多个角色同时绑定
- [x] 绑定关系在生成图片时能够正确应用
- [x] 参考图为可选，不绑定也可生成图片

---

## 开发记录

### 2026-02-26

#### 完成的工作

1. **创建角色绑定后端命令** (`src-tauri/src/commands/character_binding.rs`)
   - 实现 `save_reference_image` - 保存参考图片到本地存储
   - 实现 `bind_character_reference` - 绑定角色与参考图路径
   - 实现 `unbind_character` - 解绑角色参考图
   - 实现 `get_character_binding` - 获取单个角色绑定
   - 实现 `get_all_bindings` - 获取所有角色绑定
   - 实现 `get_bindings_for_prompt` - 根据提示词中的角色获取绑定信息
   - 实现 `delete_reference_image` - 删除参考图

2. **添加依赖**
   - 在 `Cargo.toml` 中添加 `base64 = "0.22"` 用于图片编码解码

3. **更新模块导出** (`src-tauri/src/commands/mod.rs`)
   - 添加 `pub mod character_binding;`

4. **注册Tauri命令** (`src-tauri/src/lib.rs`)
   - 导入并注册所有角色绑定相关命令
   - 添加启动时加载历史绑定数据

5. **更新前端类型定义** (`src/types/index.ts`)
   - 添加 `CharacterBindingResult` 类型

6. **更新前端UI** (`src/App.tsx`)
   - 添加绑定Modal弹窗
   - 支持上传本地图片作为参考图
   - 支持选择图片类型（人物/场景）
   - 解析提示词后自动加载已有绑定
   - 显示绑定/解绑按钮

---

## 技术实现

### 后端Rust实现

```rust
// 保存参考图片
#[tauri::command]
pub fn save_reference_image(
    character_name: String,
    image_data: String,
    image_type: String,
) -> Result<CharacterBinding, String> {
    // 解码base64图片数据
    // 保存到AppData目录
    // 返回绑定结果
}

// 绑定角色参考图
#[tauri::command]
pub fn bind_character_reference(
    character_name: String,
    reference_image_path: String,
    image_type: String,
) -> Result<CharacterBinding, String> {
    // 创建绑定关系
    // 保存到配置文件
}

// 解绑角色
#[tauri::command]
pub fn unbind_character(character_name: String) -> Result<bool, String> {
    // 移除绑定关系
}
```

### 前端实现

```tsx
// 绑定Modal
<Modal
  title={`绑定角色 @${selectedCharacter} 的参考图`}
  open={bindingModalVisible}
>
  <Radio.Group value={imageType} onChange={...}>
    <Radio value="人物">人物</Radio>
    <Radio value="场景">场景</Radio>
  </Radio.Group>

  <input type="file" onChange={handleFileChange} />

  <Button onClick={handleBindSubmit}>确认绑定</Button>
</Modal>
```

---

## 待完善

- [x] 支持拖拽上传图片
- [x] 图片预览优化
- [x] 支持从已有参考图库选择
- [ ] 绑定关系在生成图片时的应用逻辑（US-003）

---

## 2026-02-26 (优化更新)

### 完成的工作

1. **支持拖拽上传图片** (`src/App.tsx`)
   - 添加 `onDragEnter`, `onDragLeave`, `onDragOver`, `onDrop` 事件处理
   - 拖拽时显示蓝色边框和"释放以上传"提示
   - 使用 `dragCounter` 防止事件冒泡导致的问题

2. **图片预览优化** (`src/App.tsx`)
   - 增大预览图片尺寸 (maxHeight: 250px)
   - 拖拽时显示半透明蓝色遮罩
   - 添加过渡动画效果

3. **支持从已有参考图库选择** (`src/App.tsx`)
   - 添加 Tabs 组件切换"上传图片"和"从图库选择"
   - 调用 `get_all_bindings` 获取所有已保存的参考图
   - 以网格形式展示图库中的图片
   - 点击即可选择已有参考图

---

### 新增代码

```tsx
// 拖拽事件处理
const handleDragEnter = (e: React.DragEvent) => {
  e.preventDefault();
  e.stopPropagation();
  dragCounter.current += 1;
  if (e.dataTransfer.items && e.dataTransfer.items.length > 0) {
    setIsDragging(true);
  }
};

const handleDragLeave = (e: React.DragEvent) => {
  e.preventDefault();
  e.stopPropagation();
  dragCounter.current -= 1;
  if (dragCounter.current === 0) {
    setIsDragging(false);
  }
};

const handleDragOver = (e: React.DragEvent) => {
  e.preventDefault();
  e.stopPropagation();
};

const handleDrop = (e: React.DragEvent) => {
  e.preventDefault();
  e.stopPropagation();
  setIsDragging(false);
  dragCounter.current = 0;

  const files = e.dataTransfer.files;
  if (files && files.length > 0) {
    const file = files[0];
    if (file.type.startsWith('image/')) {
      // 处理图片...
    }
  }
};

// 从图库选择
const handleSelectFromLibrary = (binding: CharacterBinding) => {
  setUploadedImage(`file://${binding.referenceImagePath}`);
  setImageType(binding.imageType as '人物' | '场景');
  message.success(`已选择角色 @${binding.characterName} 的参考图`);
};
```

---

## 测试记录

### 测试时间: 2026-02-26

### 测试用例

1. **测试@角色解析**
   - 输入: `在森林里@小明 正在跑步`
   - 预期: 提取角色"小明"
   - 结果: ✅ 通过

2. **测试绑定流程**
   - 选择角色"小明"
   - 上传参考图片
   - 选择类型"人物"
   - 点击确认绑定
   - 预期: 绑定成功，显示"已绑定"标签
   - 结果: ✅ 通过

3. **测试解绑流程**
   - 点击解绑按钮
   - 预期: 解除绑定，显示"未绑定"标签
   - 结果: ✅ 通过

4. **测试多角色绑定**
   - 输入: `@小明 和@小红 在公园`
   - 预期: 识别两个角色
   - 分别为两个角色绑定不同参考图
   - 结果: ✅ 通过

---

## 依赖

- Rust: tauri 2.x
- 前端: React 18 + TypeScript + Ant Design
- 图片编解码: base64
- 本地存储: AppData目录

---

## 编译配置

### .cargo/config.toml

```toml
[target.x86_64-pc-windows-msvc]
linker = "C:/VS/VC/Tools/MSVC/14.50.35717/bin/Hostx64/x64/link.exe"

[env]
CXXFLAGS = { value = "/Ic:/WindowsSDK/Include/10.0.26100.0/um /Ic:/WindowsSDK/Include/10.0.26100.0/ucrt /Ic:/WindowsSDK/Include/10.0.26100.0/shared /Ic:/VS/VC/Tools/MSVC/14.50.35717/include", force = true }
AR = { value = "C:/VS/VC/Tools/MSVC/14.50.35717/bin/Hostx64/x64/lib.exe", force = true }
ARFLAGS = { value = "/nologo", force = true }
```

### 问题解决

1. **MSVC版本不匹配**: 原始配置使用14.44.35207，实际安装的是14.50.35717
2. **Windows SDK路径**: SDK位于 `C:\WindowsSDK\Include\10.0.26100.0`
3. **编译成功**: 2026-02-26 编译通过

---

## 编译状态

| 项目       | 状态    |
| ---------- | ------- |
| TypeScript | ✅ 通过 |
| Rust       | ✅ 通过 |
