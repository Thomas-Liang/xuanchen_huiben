# 开发记录 - 2026-02-28 13:31

## 核心修复与优化总结

### 1. 修复界面“空白/崩溃”与死循环问题 (UI Stability)
- **现象**：由于在尝试自动简化图片比例（如将 `1024:1024` 转化为 `1:1`）时引入了 `gcd`（最大公约数）递归函数，在处理空数据或零值时触发了**无限递归或除以零错误**，导致 React 渲染崩溃，界面显示空白或提示连接拒绝。
- **修复**：增加了严密的边界检查（`NaN`、`Finite`、`Math.floor` 判断），并在初始化阶段增加了安全退回机制（Fallback to 1:1）。同时全面清理了后台残留进程，恢复了应用的正常加载。

### 2. 修复图片“保存到本地”失效及格式错误 (Image Download/Save)
- **网页版 (Web Fallback)**：解决了“右键另存为是 HTML”以及点击保存无反应的问题。
    - **原理**：由于大模型生成的图片存在跨域限制，普通的下载链接会被浏览器拦截。现改为**先抓取 Blob 数据流并转换为本地内存 URL**，从而强制浏览器触发真实的图片下载动作。
- **桌面版 (Tauri Native)**：修复了客户端环境下无法弹出“保存路径选择框”的问题。
    - **修复**：更新了 `isTauri` 的环境识别算法，确保客户端能精准识别自身身份并调用 Tauri 原生的 `plugin-dialog` 插件，弹出标准的 Windows 文件保存窗口。

### 3. 配置管理与显示优化 (Configuration & UI Sync)
- **参数归一化**：针对用户反馈的生图参数中出现 `512:512` 等非比例数值的问题，后端默认值统一重置为 `1`（代表 1:1），前端加载配置时会自动进行比例约简。
- **默认配置加载**：修正了 `loadGenerationConfig` 在读取本地持久化数据时的解析异常，确保用户上次选中的比例和模型在重启后能正确回显。

### 4. 环境与进程维护 (DevOps/Process Management)
- 执行了多次深度系统清理，清理了 `node`、`tauri`、`vite`、`xuanchen-huiben` 等残留孤儿进程，解决了由于端口占用（1421/8888）导致的“拒绝连接”和页面无法刷新的硬性故障。

---

**关键变动文件：**
- `src/App.tsx` (比例计算安全增强、渲染生命周期维护)
- `src/api.ts` (跨平台下载逻辑重构、环境识别升级)
- `src-tauri/src/api.rs` (默认参数 Fallback 修正)
- `src-tauri/src/commands/image_generator.rs` (默认宽高比逻辑同步)
- `src-tauri/src/lib.rs` (后端 API 路由与进程管理)

---
*操作记录已同步，应用目前处于稳定运行状态。*
